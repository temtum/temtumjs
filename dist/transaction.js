function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_unsupportedIterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _iterableToArray(a){if("undefined"!=typeof Symbol&&null!=a[Symbol.iterator]||null!=a["@@iterator"])return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a))return _arrayLikeToArray(a)}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),Object.defineProperty(a,"prototype",{writable:!1}),a}var crypto=require("crypto"),fs=require("fs"),secp256k1=require("secp256k1"),zstd=require("zstd-lib"),Transaction=/*#__PURE__*/function(){var a=Number.isInteger;function b(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"regular";_classCallCheck(this,b),this.type=a,this.txIns=[],this.txOuts=[]}return _createClass(b,[{key:"create",value:function create(c,d,e,f){if(b.hasValidUtxo(c),!/^([0-9A-Fa-f]{64})$/.test(f))throw new Error("Wrong private key.");if(!/^([0-9A-Fa-f]{66})$/.test(d))throw new Error("Wrong recipient address.");if(!a(e)||1>e)throw new Error("Wrong amount.");var g=c[0].address;if(g===d)throw new Error("The sender address cannot match the recipient address.");var h=secp256k1.publicKeyCreate(Buffer.from(f,"hex"));if(h.toString("hex")!==g)throw new Error("Wrong pairs address/privateKey");var i=c.reduce(function(c,a){return c+a.amount},0),j=i-e;if(0>j)throw new Error("The sender does not have enough to pay for the transaction.");this.timestamp=b.getTimestamp(),this.txIns=c,this.txOuts=[{address:d,amount:e},{address:g,amount:j}],this.sign(c,f);var k={type:this.type,txIns:this.txIns,txOuts:this.txOuts,timestamp:this.timestamp,id:this.id};return Buffer.from(JSON.stringify(k)).toString("hex")}},{key:"sign",value:function sign(a,c){var d=[this.type,this.timestamp,JSON.stringify(this.txIns),JSON.stringify(this.txOuts)];this.id=b.sha256Hex(d.join("")),this.txIns=b.signInputs(this.id,a,c)}},{key:"createWithData",value:function createWithData(a,c,d,e,f,g){if(this.timestamp=b.getTimestamp(),!d)this.txIns=[{address:a,amount:0,dataHash:e,token:g}],this.txOuts=[{address:c,amount:0,dataHash:e}],this.signData(f);else if("37"===d[0].toString()&&"80"===d[1].toString()&&"68"===d[2].toString()&&"70"===d[3].toString()&&"45"===d[4].toString()){d=zstd.compressSync(d,{level:5});var i=_toConsumableArray(d);this.txIns=[{address:a,amount:0,dataHash:"",token:g}],this.txOuts=[{address:c,amount:0,dataHash:"",data:{type:"pdf",data:i}}],this.txOuts[0].dataHash=b.sha256Hex(this.txOuts[0].data.data.join("")),this.txIns[0].dataHash=b.sha256Hex(this.txOuts[0].data.data.join("")),this.signData(f),this.txOuts[0].dataHash=""}else throw new Error("Wrong data type.");var h={type:this.type,txIns:this.txIns,txOuts:this.txOuts,timestamp:this.timestamp,id:this.id};return Buffer.from(JSON.stringify(h)).toString("hex")}},{key:"signData",value:function signData(a){var c=JSON.stringify(this.txOuts,function(a,b){return"data"===a?void 0:b}),d=[this.type,this.timestamp,JSON.stringify(this.txIns),c];this.id=b.sha256Hex(d.join("")),this.txIns=b.signDataInputs(this.id,this.txIns,a)}}],[{key:"getTimestamp",value:function getTimestamp(){var a=Math.floor;return a(Date.now()/1e3)}},{key:"sha256Hex",value:function sha256Hex(a){return crypto.createHash("sha256").update(a).digest("hex")}},{key:"hasValidUtxo",value:function hasValidUtxo(b){var c=b.length;if(!c)throw new Error("Wrong UTXO.");for(var d,e=0;e<c;e++)if(d=b[e],!a(d.amount)||1>d.amount)throw new Error("Wrong input amount.")}},{key:"signInput",value:function signInput(a,c){var d=b.sha256Hex(a.join("")),e=secp256k1.sign(Buffer.from(d,"hex"),Buffer.from(c,"hex")),f=e.signature;return f.toString("hex")}},{key:"signInputs",value:function signInputs(a,c,d){try{for(var g=0,h=c.length;g<h;g++){var e=c[g],f=[a,e.txOutIndex,e.txOutId,e.amount,e.address];e.signature=b.signInput(f,d)}return c}catch(a){throw new Error("Error signing inputs ".concat(c,": ").concat(a))}}},{key:"signDataInputs",value:function signDataInputs(a,c,d){var e=c[0],f=[a,e.amount,e.address,e.dataHash],g=b.sha256Hex(f.join("")),h=secp256k1.sign(Buffer.from(g,"hex"),Buffer.from(d,"hex"));return e.signature=h.signature.toString("hex"),c}}]),b}();module.exports=Transaction;